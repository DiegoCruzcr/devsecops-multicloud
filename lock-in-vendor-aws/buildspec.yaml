version: 0.2

phases:
  pre_build:
    commands:
      - echo "Deploy do cloudformation iniciado..."
      - cd lock-in-vendor-aws
      - chmod +x deploy.sh
      - ./deploy.sh
      - cd ..
      - echo "Logando no ECR"
      - aws ecr get-login-password | docker login --username AWS --password-stdin 782622073147.dkr.ecr.us-east-1.amazonaws.com/python-app-devsecops-stack
  build:
    commands:
      - echo "Construindo a imagem Docker"
      - cd lock-in-vendor-aws
      - docker build -t python-app-devsecops-stack .
      - docker tag python-app-devsecops-stack:latest 782622073147.dkr.ecr.us-east-1.amazonaws.com/python-app-devsecops-stack:latest
  post_build:
    commands:
      - echo "Fazendo push da imagem para o ECR"
      - docker push 782622073147.dkr.ecr.us-east-1.amazonaws.com/python-app-devsecops-stack:latest
      - echo "Criando artefato de imagem para deploy"
      - printf '[{"name":"python-app-devsecops-stack","imageUri":"%s"}]' 782622073147.dkr.ecr.us-east-1.amazonaws.com/python-app-devsecops-stack:latest > imagedefinitions.json

artifacts:
  files: lock-in-vendor-aws/imagedefinitions.json
